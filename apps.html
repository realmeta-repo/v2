<!-- work.html - Grid de apps com artigos da pasta 'apps' -->
<div style="width:100%; max-width:100%; margin:0 auto; padding:76px 0 40px 0; box-sizing:border-box;">

    <!-- Template para cards (otimizado para performance) -->
    <template id="work-card-template">
        <a class="work-grid-card" data-page="">
            <div class="work-grid-card-image-container">
                <div class="work-grid-card-image-layer">
                    <img data-src="" alt="" class="work-zoom-layer" 
                         style="position:absolute; top:0; left:50%; width:150%; height:100%; object-fit:cover; transform:translateX(-50%) scale(1.33); transition:transform 0.6s cubic-bezier(.25,.46,.45,.94);" 
                         loading="lazy" width="420" height="280">
                </div>
                <div class="work-grid-card-overlay">
                    <h3 class="work-grid-card-title"></h3>
                    <p class="work-grid-card-description"></p>
                    <div class="work-grid-card-footer">
                        <div class="work-grid-card-tags"></div>
                        <span class="work-grid-card-btn">Ver detalhes</span>
                    </div>
                </div>
            </div>
        </a>
    </template>

    <!-- Container do grid -->
    <div id="workGridContainer" style="
        max-width: 900px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: repeat(3, 280px);
        grid-auto-rows: 380px;
        gap: 30px;
        justify-content: center;
        padding: 0 20px;
    ">
        <!-- Cards serão gerados dinamicamente aqui -->
    </div>

    <!-- Indicadores -->
    <div id="workLoadingIndicator" style="
        display: none;
        text-align: center;
        padding: 40px;
        color: #666;
        font-family: Tahoma, Arial, sans-serif;
        font-size: .85rem;
        letter-spacing: .08em;
    ">
        Carregando mais apps...
    </div>

    <div id="workNoApps" style="
        display: none;
        text-align: center;
        padding: 80px 20px;
        color: #666;
        font-family: Tahoma, Arial, sans-serif;
        font-size: .95rem;
    ">
        Nenhum app encontrado.
    </div>

</div>

<!-- Estilos otimizados para performance -->
<style>
    /* Otimizações de performance */
    .work-grid-card {
        will-change: transform;
        contain: content;
        backface-visibility: hidden;
        transform: translateZ(0);
    }
    
    .work-grid-card-image-layer {
        backface-visibility: hidden;
        transform: translateZ(0);
    }
    
    /* Prioridade de renderização para melhor performance */
    .work-grid-card-title,
    .work-grid-card-btn {
        content-visibility: auto;
    }
    
    /* Fallback para browsers sem suporte a content-visibility */
    @supports not (content-visibility: auto) {
        .work-grid-card {
            transform: translateZ(0);
        }
    }
    
    /* Estilos do carrossel original mantidos */
    @keyframes workPan {
        0%   { transform: translateX(-10%); }
        50%  { transform: translateX(10%); }
        100% { transform: translateX(-10%); }
    }
    
    /* Animação de hover IDÊNTICA */
    .work-grid-card:hover .work-zoom-layer {
        transform: translateX(-50%) scale(1) !important;
    }
    
    .work-grid-card-btn:hover {
        background: rgba(255,255,255,.35) !important;
        transform: translateY(-1px) !important;
    }
    
    /* Responsividade do grid */
    @media (max-width: 920px) {
        #workGridContainer {
            grid-template-columns: repeat(2, 280px) !important;
            gap: 25px !important;
        }
    }
    
    @media (max-width: 620px) {
        #workGridContainer {
            grid-template-columns: 280px !important;
            gap: 20px !important;
            padding: 0 10px !important;
        }
    }
    
    /* Card com sombras melhoradas para grid */
    .work-grid-card {
        flex: 0 0 280px !important;
        height: 380px !important;
        display: block !important;
        text-decoration: none !important;
        color: inherit !important;
        position: relative !important;
        overflow: hidden !important;
        cursor: pointer !important;
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
        border-radius: 4px !important;
        
        /* Sombra mais suave para grid */
        box-shadow: 
            0 4px 8px rgba(0, 0, 0, 0.05),
            0 6px 16px rgba(0, 0, 0, 0.05),
            0 12px 24px rgba(0, 0, 0, 0.06) !important;
    }
    
    .work-grid-card:hover {
        transform: translateY(-6px) scale(1.01) !important;
        
        /* Sombra mais pronunciada no hover */
        box-shadow: 
            0 8px 16px rgba(0, 0, 0, 0.08),
            0 12px 24px rgba(0, 0, 0, 0.08),
            0 20px 40px rgba(0, 0, 0, 0.10) !important;
    }
    
    /* Borda sutil para melhor definição */
    .work-grid-card::before {
        content: '' !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        border: 1px solid rgba(0, 0, 0, 0.04) !important;
        border-radius: 4px !important;
        pointer-events: none !important;
        z-index: 1 !important;
    }
    
    .work-grid-card-image-container {
        position: absolute !important;
        inset: 0 !important;
        width: 100% !important;
        height: 100% !important;
        overflow: hidden !important;
        border-radius: 4px !important;
    }
    
    .work-grid-card-image-layer {
        position: absolute !important;
        inset: 0 !important;
        animation: workPan 60s linear infinite !important;
        border-radius: 4px !important;
    }
    
    .work-grid-card-overlay {
        position: absolute !important;
        inset: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: flex-end !important;
        padding: 22px !important;
        background: linear-gradient(to top,
            rgba(0, 0, 0, 0.88),
            rgba(0, 0, 0, 0.45),
            rgba(0, 0, 0, 0)) !important;
        color: #fff !important;
        z-index: 2 !important;
        border-radius: 4px !important;
    }
    
    .work-grid-card-title {
        font-family: Montserrat, sans-serif !important;
        font-weight: 800 !important;
        text-transform: uppercase !important;
        letter-spacing: .06em !important;
        font-size: 1rem !important;
        margin: 0 0 10px 0 !important;
        line-height: 1.25 !important;
        text-shadow: 0 4px 14px rgba(0, 0, 0, 0.9) !important;
    }
    
    .work-grid-card-description {
        font-family: Tahoma, Arial, sans-serif !important;
        line-height: 1.45 !important;
        font-size: 0.82rem !important;
        margin: 0 0 18px 0 !important;
        opacity: 0.92 !important;
        display: -webkit-box !important;
        -webkit-line-clamp: 2 !important;
        -webkit-box-orient: vertical !important;
        overflow: hidden !important;
        text-shadow: 0 3px 12px rgba(0, 0, 0, 0.85) !important;
    }
    
    .work-grid-card-footer {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        width: 100% !important;
    }
    
    .work-grid-card-tags {
        font-size: .65rem !important;
        opacity: .75 !important;
        font-family: Tahoma, Arial, sans-serif !important;
        display: -webkit-box !important;
        -webkit-line-clamp: 1 !important;
        -webkit-box-orient: vertical !important;
        overflow: hidden !important;
        flex: 1 !important;
        margin-right: 10px !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    .work-grid-card-btn {
        background: rgba(255, 255, 255, 0.15) !important;
        border: 1px solid rgba(255, 255, 255, 0.25) !important;
        padding: 6px 16px !important;
        border-radius: 999px !important;
        font-size: .7rem !important;
        font-family: Tahoma, Arial, sans-serif !important;
        white-space: nowrap !important;
        transition: all 0.3s ease !important;
        backdrop-filter: blur(4px) !important;
        -webkit-backdrop-filter: blur(4px) !important;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
    }
    
    .work-grid-card:hover .work-grid-card-btn {
        background: rgba(255, 255, 255, 0.25) !important;
        border-color: rgba(255, 255, 255, 0.35) !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15) !important;
    }
    
    /* Melhoria de contraste para melhor legibilidade */
    .work-grid-card-overlay::before {
        content: '' !important;
        position: absolute !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        height: 80% !important;
        background: linear-gradient(to top,
            rgba(0, 0, 0, 0.7) 0%,
            rgba(0, 0, 0, 0.4) 60%,
            transparent 100%) !important;
        z-index: -1 !important;
        border-radius: 4px !important;
    }
    
    /* Redução de motion para acessibilidade */
    @media (prefers-reduced-motion: reduce) {
        .work-grid-card-image-layer {
            animation: none !important;
        }
        
        /* Não aplicamos transição quando o usuário prefere reduzir movimento */
        .work-grid-card {
            transition: none !important;
        }
        
        .work-grid-card-btn {
            transition: none !important;
        }
    }
    
    /* Melhoria de foco para acessibilidade */
    .work-grid-card:focus {
        outline: 2px solid rgba(0, 123, 255, 0.5) !important;
        outline-offset: 2px !important;
    }
    
    /* Estilos para lazy loading */
    .work-grid-card img:not([data-src]) {
        opacity: 1;
        transition: opacity 0.3s ease;
    }
    
    .work-grid-card img[data-src] {
        opacity: 0;
    }
    
    .work-grid-card img.loaded {
        opacity: 1;
    }
</style>

<script>
// IIFE para evitar conflitos
(function() {
    'use strict';
    
    // Configurações
    const APPS_PER_PAGE = 9;
    const MAX_CONCURRENT_FETCHES = 3;
    let currentPage = 1;
    let isLoading = false;
    let allApps = [];
    let imageObserver = null;
    
    // Flag para sinalizar quando o grid está pronto
    window.workGridReady = false;
    
    // Mapeamento de apps existentes na pasta 'apps'
    const appFiles = {
        'app-automacao-industrial': 'apps/automacao-industrial.html',
        'app-logistica-inteligente': 'apps/artigo2.html',
        // Adicione mais apps conforme necessário
    };
    
    // Aguardar DOM
    function waitForDOM() {
        return new Promise(resolve => {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', resolve);
            } else {
                setTimeout(resolve, 100);
            }
        });
    }
    
    // Processar apps em batches para não sobrecarregar
    async function processAppsInParallel(files, maxConcurrent = MAX_CONCURRENT_FETCHES) {
        const results = [];
        
        for (let i = 0; i < files.length; i += maxConcurrent) {
            const batch = files.slice(i, i + maxConcurrent);
            const batchPromises = batch.map(fileName => 
                extractAppMetadata(fileName)
            );
            
            const batchResults = await Promise.allSettled(batchPromises);
            batchResults.forEach(result => {
                if (result.status === 'fulfilled' && result.value) {
                    results.push(result.value);
                }
            });
            
            // Pequena pausa entre batches para não sobrecarregar
            if (i + maxConcurrent < files.length) {
                await new Promise(resolve => setTimeout(resolve, 50));
            }
        }
        
        return results;
    }
    
    // Extrair metadados do app
    async function extractAppMetadata(fileName) {
        try {
            console.log('Carregando app:', fileName);
            const response = await fetch(fileName);
            if (!response.ok) {
                console.warn('App não encontrado:', fileName);
                return null;
            }
            
            const html = await response.text();
            const tempDiv = document.createElement('div');
            
            // Limpar tags de arquivo de forma otimizada
            const cleanHtml = html.replace(/\[file name\]:.*?\n/gi, '')
                                  .replace(/\[file content begin\]/gi, '')
                                  .replace(/\[file content end\]/gi, '')
                                  .trim();
            
            tempDiv.innerHTML = cleanHtml;
            
            // Extrair título do app (pode estar em diferentes elementos)
            let title = 'App sem título';
            const titleElement = tempDiv.querySelector('.article-banner h1') || 
                               tempDiv.querySelector('h1') ||
                               tempDiv.querySelector('.app-title') ||
                               tempDiv.querySelector('.title');
            
            if (titleElement) {
                title = titleElement.textContent.trim();
            }
            
            // Extrair descrição do app
            let description = '';
            const descElement = tempDiv.querySelector('.article-banner p') || 
                              tempDiv.querySelector('.app-description') ||
                              tempDiv.querySelector('.description') ||
                              tempDiv.querySelector('p');
            
            if (descElement) {
                description = descElement.textContent.trim();
            }
            
            // Extrair imagem do app
            let imageUrl = 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?auto=format&fit=crop&w=560&q=80'; // Imagem padrão para apps
            
            const imgElement = tempDiv.querySelector('.article-banner img') || 
                             tempDiv.querySelector('.app-image img') ||
                             tempDiv.querySelector('img');
            
            if (imgElement && imgElement.src) {
                imageUrl = imgElement.src;
            }
            
            // Extrair tags (máximo 3)
            let tags = [];
            const tagElements = tempDiv.querySelectorAll('.hashtags-component .article-tags span, .app-tags span, .tags span');
            
            if (tagElements.length > 0) {
                for (let i = 0; i < Math.min(3, tagElements.length); i++) {
                    const tag = tagElements[i].textContent.trim().replace('#', '');
                    if (tag.length > 0) tags.push(tag);
                }
            } else {
                // Tags padrão para apps
                tags = ['app', 'tecnologia', 'solução'];
            }
            
            // Determinar data-page
            const dataPage = Object.keys(appFiles).find(key => appFiles[key] === fileName) || 
                           fileName.replace('apps/', '').replace('.html', '');
            
            return {
                dataPage,
                title: title.substring(0, 80),
                description: description.substring(0, 120),
                imageUrl,
                tags: tags,
                fileName
            };
            
        } catch (error) {
            console.error('Erro ao processar app:', fileName, error);
            return null;
        }
    }
    
    // Configurar lazy loading com Intersection Observer
    function setupLazyLoading() {
        if (imageObserver) {
            imageObserver.disconnect();
        }
        
        imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const src = img.dataset.src;
                    
                    if (src) {
                        // Carregar a imagem
                        img.src = src;
                        img.classList.add('loaded');
                        
                        // Remover atributo data-src para evitar recarregamento
                        img.removeAttribute('data-src');
                        
                        // Parar de observar esta imagem
                        imageObserver.unobserve(img);
                        
                        console.log('Imagem do app carregada via lazy loading:', src);
                    }
                }
            });
        }, {
            rootMargin: '100px 0px',
            threshold: 0.01
        });
        
        // Observar todas as imagens com data-src
        document.querySelectorAll('.work-grid-card img[data-src]').forEach(img => {
            imageObserver.observe(img);
        });
        
        console.log('Lazy loading configurado para', document.querySelectorAll('.work-grid-card img[data-src]').length, 'imagens');
    }
    
    // Criar card usando template (mais performático)
    function createAppCard(app) {
        const template = document.getElementById('work-card-template');
        const card = template.content.cloneNode(true);
        const cardElement = card.querySelector('.work-grid-card');
        
        cardElement.setAttribute('data-page', app.dataPage);
        
        // Formatar tags para exibição
        const tagsText = app.tags.length > 0 ? 
            app.tags.map(tag => `#${tag}`).join(' ') : 
            '#app';
        
        // Preencher template
        const img = cardElement.querySelector('img');
        img.alt = app.title;
        img.dataset.src = app.imageUrl; // Usar data-src para lazy loading
        img.width = 420;
        img.height = 280;
        
        cardElement.querySelector('.work-grid-card-title').textContent = app.title;
        cardElement.querySelector('.work-grid-card-description').textContent = app.description;
        cardElement.querySelector('.work-grid-card-tags').textContent = tagsText;
        
        // Evento de clique para abrir app
        cardElement.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Usar a função do app shell ou fallback
            if (typeof window.blinkAnimation === 'function') {
                window.blinkAnimation(app.dataPage);
            } else {
                // Tentar usar o sistema de navegação do app shell
                const event = new CustomEvent('triggerBlink', {
                    detail: { page: app.dataPage },
                    bubbles: true
                });
                window.dispatchEvent(event);
            }
        });
        
        return cardElement;
    }
    
    // Carregar apps com renderização sincronizada e lazy loading
    async function loadApps(page = 1) {
        if (isLoading) return;
        
        isLoading = true;
        const loadingIndicator = document.getElementById('workLoadingIndicator');
        const noApps = document.getElementById('workNoApps');
        const gridContainer = document.getElementById('workGridContainer');
        
        if (loadingIndicator) loadingIndicator.style.display = 'block';
        
        try {
            // Primeira página: carregar todos os apps
            if (page === 1) {
                allApps = [];
                gridContainer.innerHTML = '';
                
                // Processar apps em batches
                console.log(`Processando ${Object.values(appFiles).length} apps em batches...`);
                allApps = await processAppsInParallel(Object.values(appFiles));
                
                // Ordenar alfabeticamente por título
                allApps.sort((a, b) => a.title.localeCompare(b.title));
                
                console.log(`Apps processados: ${allApps.length}`);
                
                // Mostrar mensagem se não houver apps
                if (allApps.length === 0) {
                    if (noApps) noApps.style.display = 'block';
                    if (gridContainer) gridContainer.style.display = 'none';
                    return;
                } else {
                    if (noApps) noApps.style.display = 'none';
                    if (gridContainer) gridContainer.style.display = 'grid';
                }
            }
            
            // Calcular índices para paginação
            const startIndex = (page - 1) * APPS_PER_PAGE;
            const endIndex = startIndex + APPS_PER_PAGE;
            const appsToShow = allApps.slice(startIndex, endIndex);
            
            // Criar cards de forma síncrona
            const fragment = document.createDocumentFragment();
            appsToShow.forEach(app => {
                const card = createAppCard(app);
                fragment.appendChild(card);
            });
            
            // Adicionar todos os cards de uma vez
            gridContainer.appendChild(fragment);
            
            // Configurar lazy loading IMEDIATAMENTE após adicionar cards
            if (page === 1) {
                // Aguardar próximo frame para garantir que os elementos foram adicionados ao DOM
                await new Promise(resolve => requestAnimationFrame(resolve));
                
                // Configurar lazy loading
                setupLazyLoading();
            } else {
                // Para páginas subsequentes, atualizar o observer
                setupLazyLoading();
            }
            
            currentPage = page;
            console.log(`Carregados ${appsToShow.length} apps (página ${page})`);
            
            // Forçar renderização sincronizada
            if (page === 1) {
                // Forçar layout e renderização
                void gridContainer.offsetHeight;
                
                // Aguardar próximo frame para garantir renderização completa
                await new Promise(resolve => requestAnimationFrame(resolve));
                
                // Marcar grid como pronto (IMPORTANTE: mesmo sem imagens carregadas)
                window.workGridReady = true;
                console.log('Grid de apps renderizado e pronto para visualização (lazy loading ativo)');
                
                // Disparar evento para sincronização com blink animation
                window.dispatchEvent(new CustomEvent('workGridReady'));
            }
            
            // Esconder indicador se não há mais apps
            if (endIndex >= allApps.length && loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            
        } catch (error) {
            console.error('Erro ao carregar apps:', error);
            if (noApps) {
                noApps.textContent = 'Erro ao carregar apps. Recarregue a página.';
                noApps.style.display = 'block';
            }
        } finally {
            isLoading = false;
            if (loadingIndicator) loadingIndicator.style.display = 'none';
        }
    }
    
    // Configurar infinite scroll
    function setupInfiniteScroll() {
        let scrollTimeout;
        let lastScrollPosition = 0;
        
        function checkScroll() {
            if (isLoading) return;
            
            const scrollPosition = window.innerHeight + window.scrollY;
            const pageEnd = document.body.offsetHeight - 500;
            
            // Evitar chamadas desnecessárias se o scroll não mudou significativamente
            if (Math.abs(scrollPosition - lastScrollPosition) < 100) return;
            
            lastScrollPosition = scrollPosition;
            
            if (scrollPosition >= pageEnd) {
                const totalLoaded = currentPage * APPS_PER_PAGE;
                if (totalLoaded < allApps.length) {
                    console.log('Carregando mais apps via scroll...');
                    loadApps(currentPage + 1);
                }
            }
        }
        
        window.addEventListener('scroll', function() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(checkScroll, 150);
        }, { passive: true });
    }
    
    // Inicializar com renderização sincronizada
    async function init() {
        await waitForDOM();
        console.log('Inicializando grid de work (apps) otimizado (com lazy loading)...');
        
        // Carregar apps IMEDIATAMENTE, sem setTimeout
        await loadApps(1);
        setupInfiniteScroll();
        
        console.log('Grid de work (apps) carregado e renderizado (otimizado com lazy loading)');
    }
    
    // Iniciar
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        // Executar imediatamente se o DOM já estiver pronto
        setTimeout(init, 0);
    }
    
    // Expor função para adicionar apps dinamicamente
    window.addWorkApp = function(fileName, dataPage) {
        if (!appFiles[dataPage]) {
            appFiles[dataPage] = fileName;
            
            // Recarregar apps se estiver na primeira página
            if (currentPage === 1 && allApps.length < APPS_PER_PAGE) {
                loadApps(1);
            }
        }
    };
    
})();
</script>